{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ikram/Desktop/clinical/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\ndeclare global {\r\n  var prisma: PrismaClient | undefined;\r\n}\r\n\r\nexport const prisma =\r\n  global.prisma ??\r\n  new PrismaClient();\r\n\r\nif (process.env.NODE_ENV !== \"production\") global.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAMO,MAAM,SACX,OAAO,MAAM,IACb,IAAI,6IAAY;AAElB,wCAA2C,OAAO,MAAM,GAAG"}},
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ikram/Desktop/clinical/src/server/rbac.ts"],"sourcesContent":["// server/rbac.ts\r\nimport type { NextApiRequest, NextApiResponse } from \"next\";\r\nimport { getToken } from \"next-auth/jwt\"; // si tu utilises next-auth\r\n// sinon je te donne version JWT manuelle plus bas\r\n\r\nexport interface AuthSession {\r\n  user: {\r\n    id: string;\r\n    role: \"ADMIN\" | \"DOCTOR\" | \"RECEPTIONIST\" | \"PATIENT\";\r\n  };\r\n}\r\n\r\nexport async function requireRole(\r\n  req: NextApiRequest,\r\n  res: NextApiResponse,\r\n  allowedRoles: string[]\r\n): Promise<AuthSession | null> {\r\n  const token = await getToken({ req });\r\n\r\n  if (!token) {\r\n    res.status(401).json({ error: \"Not authenticated\" });\r\n    return null;\r\n  }\r\n\r\n  // token.sub = ID utilisateur\r\n  const session: AuthSession = {\r\n    user: {\r\n      id: token.sub as string,\r\n      role: token.role as any\r\n    }\r\n  };\r\n\r\n  if (!allowedRoles.includes(session.user.role)) {\r\n    res.status(403).json({ error: \"Forbidden\" });\r\n    return null;\r\n  }\r\n\r\n  return session;\r\n}\r\n"],"names":[],"mappings":"AAAA,iBAAiB;;;;;AAEjB,4NAA0C,2BAA2B;;AAU9D,eAAe,YACpB,GAAmB,EACnB,GAAoB,EACpB,YAAsB;IAEtB,MAAM,QAAQ,MAAM,IAAA,2IAAQ,EAAC;QAAE;IAAI;IAEnC,IAAI,CAAC,OAAO;QACV,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAoB;QAClD,OAAO;IACT;IAEA,6BAA6B;IAC7B,MAAM,UAAuB;QAC3B,MAAM;YACJ,IAAI,MAAM,GAAG;YACb,MAAM,MAAM,IAAI;QAClB;IACF;IAEA,IAAI,CAAC,aAAa,QAAQ,CAAC,QAAQ,IAAI,CAAC,IAAI,GAAG;QAC7C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAY;QAC1C,OAAO;IACT;IAEA,OAAO;AACT"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ikram/Desktop/clinical/src/pages/api/prescriptions/%5Bid%5D/pdf.ts"],"sourcesContent":["// pages/api/prescriptions/[id]/pdf.ts\r\nimport type { NextApiRequest, NextApiResponse } from \"next\";\r\nimport { prisma } from \"../../../../lib/prisma\";\r\nimport PDFDocument from \"pdfkit\";\r\nimport { requireRole } from \"../../../../server/rbac\";\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== \"GET\") {\r\n    return res.status(405).end();\r\n  }\r\n\r\n  const session = await requireRole(req, res, [\"PATIENT\", \"DOCTOR\", \"ADMIN\"]);\r\n  if (!session) return;\r\n\r\n  const { id } = req.query;\r\n  if (typeof id !== \"string\") {\r\n    return res.status(400).json({ error: \"ID invalide\" });\r\n  }\r\n\r\n  const prescription = await prisma.prescription.findUnique({\r\n    where: { id },\r\n    include: { \r\n      doctor: true, \r\n      patient: { include: { owner: true } }, // ‚Üê Important pour v√©rifier l'acc√®s\r\n      consultation: true \r\n    }\r\n  });\r\n\r\n  if (!prescription) {\r\n    return res.status(404).json({ error: \"Ordonnance introuvable\" });\r\n  }\r\n\r\n  // üîí V√©rification d'acc√®s\r\n  let hasAccess = false;\r\n\r\n  if (session.user.role === \"PATIENT\") {\r\n    hasAccess = prescription.patient.ownerId === session.user.id;\r\n  } else if (session.user.role === \"DOCTOR\") {\r\n    hasAccess = prescription.doctorId === session.user.id;\r\n  } else {\r\n    hasAccess = true; // ADMIN\r\n  }\r\n\r\n  if (!hasAccess) {\r\n    return res.status(403).json({ error: \"Acc√®s refus√©\" });\r\n  }\r\n\r\n  // ‚úÖ G√©n√©ration du PDF\r\n  try {\r\n    res.setHeader(\"Content-Type\", \"application/pdf\");\r\n    res.setHeader(\"Content-Disposition\", `inline; filename=ordonnance-${prescription.id}.pdf`);\r\n\r\n    const doc = new PDFDocument({ size: \"A4\", margin: 50 });\r\n    doc.pipe(res);\r\n\r\n    // Titre\r\n    doc.fontSize(20).text(\"ORDONNANCE M√âDICALE\", { align: \"center\" });\r\n    doc.moveDown();\r\n\r\n    // M√©decin\r\n    doc.fontSize(12).text(`Dr. ${prescription.doctor?.name || \"Non sp√©cifi√©\"}`);\r\n    if (prescription.doctor?.email) {\r\n      doc.text(`Email: ${prescription.doctor.email}`);\r\n    }\r\n    doc.moveDown();\r\n\r\n    // Patient\r\n    doc.text(`Patient: ${prescription.patient.firstName} ${prescription.patient.lastName}`);\r\n    if (prescription.patient.email) doc.text(`Email: ${prescription.patient.email}`);\r\n    if (prescription.patient.phone) doc.text(`T√©l√©phone: ${prescription.patient.phone}`);\r\n    doc.moveDown();\r\n\r\n    // Consultation (si li√©e)\r\n    if (prescription.consultation) {\r\n      doc.text(`Consultation du: ${new Date(prescription.consultation.datetime).toLocaleDateString(\"fr-FR\")}`);\r\n      if (prescription.consultation.diagnosis) {\r\n        doc.moveDown();\r\n        doc.text(\"Diagnostic:\", { underline: true });\r\n        doc.text(prescription.consultation.diagnosis);\r\n      }\r\n      doc.moveDown();\r\n    }\r\n\r\n    // M√©dicaments\r\n    doc.text(\"M√©dicaments prescrits:\", { underline: true });\r\n    const meds = (prescription.medications || []) as any[];\r\n    if (meds.length === 0) {\r\n      doc.text(\"Aucun m√©dicament prescrit.\");\r\n    } else {\r\n      meds.forEach((m, idx) => {\r\n        doc.moveDown(0.2);\r\n        const lines = [`‚Ä¢ ${m.name || \"M√©dicament\"}`];\r\n        if (m.dosage) lines.push(`Dosage: ${m.dosage}`);\r\n        if (m.frequency) lines.push(`Fr√©quence: ${m.frequency}`);\r\n        if (m.duration) lines.push(`Dur√©e: ${m.duration} jours`);\r\n        if (m.notes) lines.push(`Notes: ${m.notes}`);\r\n        doc.fontSize(11).text(lines.join(\" | \"));\r\n      });\r\n    }\r\n\r\n    doc.moveDown(2);\r\n    doc.fontSize(10).text(\"Ce document a √©t√© g√©n√©r√© √©lectroniquement.\", { align: \"center\" });\r\n    doc.text(\"Signature non requise selon l'article R. 4127-6 du Code de la sant√© publique.\", { align: \"center\" });\r\n\r\n    doc.end();\r\n  } catch (err) {\r\n    console.error(\"Erreur g√©n√©ration PDF:\", err);\r\n    if (!res.headersSent) {\r\n      res.status(500).json({ error: \"Erreur lors de la g√©n√©ration du PDF\" });\r\n    }\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}