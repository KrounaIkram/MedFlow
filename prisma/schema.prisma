generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----- Utilisateurs -----
model User {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  password  String?
  role      Role     @default(PATIENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations propres
  patients           Patient[]      @relation("OwnerPatients")
  doctorAppointments Appointment[]  @relation("DoctorAppointments")
  consultations      Consultation[] @relation("DoctorConsultations")
  prescriptions      Prescription[] @relation("DoctorPrescriptions")
}

// ----- Patients -----
model Patient {
  id        String    @id @default(cuid())
  firstName String
  lastName  String
  dob       DateTime?
  phone     String?
  email     String?   @unique
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  ownerId       String?
  owner         User?          @relation("OwnerPatients", fields: [ownerId], references: [id])
  appointments  Appointment[]  @relation("PatientAppointments")
  consultations Consultation[] @relation("PatientConsultations")
  prescriptions Prescription[] @relation("PatientPrescriptions")
  invoices      Invoice[]
}

// ----- Rendez-vous -----
model Appointment {
  id        Int               @id @default(autoincrement())
  date      DateTime
  duration  Int
  type      AppointmentType   @default(CONSULTATION)
  status    AppointmentStatus @default(SCHEDULED)
  notes     String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  doctorId  String
  doctor    User    @relation("DoctorAppointments", fields: [doctorId], references: [id])
  patientId String
  patient   Patient @relation("PatientAppointments", fields: [patientId], references: [id])

  @@index([doctorId, date])
  @@index([patientId])
}

// ----- Consultation -----
model Consultation {
  id           String        @id @default(cuid())
  doctorId     String
  doctor       User          @relation("DoctorConsultations", fields: [doctorId], references: [id])
  patientId    String
  patient      Patient       @relation("PatientConsultations", fields: [patientId], references: [id])
  datetime     DateTime
  duration     Int?
  diagnosis    String?
  notes        String?
  prescription Prescription?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  invoices  Invoice[]
}

// ----- Ordonnance -----
model Prescription {
  id             String       @id @default(cuid())
  consultationId String      @unique
  consultation   Consultation @relation(fields: [consultationId], references: [id])

  doctorId  String
  doctor    User    @relation("DoctorPrescriptions", fields: [doctorId], references: [id])
  patientId String
  patient   Patient @relation("PatientPrescriptions", fields: [patientId], references: [id])

  medications Json
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Invoice {
  id                    String        @id @default(cuid())
  patientId             String
  patient               Patient       @relation(fields: [patientId], references: [id])
  consultationId        String?
  consultation          Consultation? @relation(fields: [consultationId], references: [id])
  amount                Int // en centimes (ex: 7500 = 75,00 â‚¬)
  currency              String        @default("eur")
  status                InvoiceStatus @default(PENDING)
  stripePaymentIntentId String?
  createdAt             DateTime      @default(now())
  paidAt                DateTime?
  payments              Payment[]

  @@index([patientId])
}

model Payment {
  id              String        @id @default(cuid())
  invoiceId       String
  invoice         Invoice       @relation(fields: [invoiceId], references: [id])
  stripePaymentId String        @unique
  amount          Int
  currency        String        @default("eur")
  status          PaymentStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELED
}

enum Role {
  ADMIN
  DOCTOR
  RECEPTIONIST
  PATIENT
}

enum AppointmentType {
  CONSULTATION
  URGENCY
  FOLLOW_UP
  CONTROL
}

enum AppointmentStatus {
  SCHEDULED
  CANCELLED
  DONE
}
